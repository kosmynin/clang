
if(CMAKE_VERSION VERSION_LESS 3.1.20141117)
  set(cmake_3_2_USES_TERMINAL)
else()
  set(cmake_3_2_USES_TERMINAL USES_TERMINAL)
endif()


set(SOTOC_TEST_COMPILER ${CMAKE_C_COMPILER} CACHE STRING
    "Compiler to use for testing sotoc")

set(SOTOC_EXECUTABLE ${CMAKE_BINARY_DIR}/sotoc)


find_package(PythonInterp REQUIRED)

if(NOT PYTHONINTERP_FOUND)
  message(WARNING "Could not find Python.")
  message(WARNING "The check-sotoc target will not be available!")
  return()
endif()

find_program(SOTOC_LLVM_LIT_EXECUTABLE
  NAMES llvm-lit lit.py lit
  PATHS ${SOTOC_LLVM_TOOLS_DIR})

if(NOT SOTOC_LLVM_LIT_EXECUTABLE)
    message(WARNING "Cannot find llvm-lit.")
    message(WARNING "Please put llvm-lit in your PATH, set SOTOC_LLVM_LIT_EXECUTABLE to its full path or point SOTOC_LLVM_TOOLS_DIR to its directory")
    message(WARNING "The check-sotoc target will not be available!")
    return()
endif()


set(SOTOC_LIT_ARGS -s -v --no-progress-bar)


add_custom_target(check-sotoc
  COMMAND ${PYTHON_EXECUTABLE} ${SOTOC_LLVM_LIT_EXECUTABLE} ${SOTOC_LIT_ARGS} ${CMAKE_CURRENT_BINARY_DIR}
    DEPENDS sotoc
    COMMENT "Running sotoc tests"
    ${cmake_3_2_USES_TERMINAL}
  )


# Configure the lit.site.cfg.in file
set(SOTOC_BASE_DIR ${PROJECT_SOURCE_DIR})
set(SOTOC_OBJ_ROOT ${CMAKE_CURRENT_BINARY_DIR})
set(AUTO_GEN_COMMENT "## Autogenerated by libomp configuration.\n# Do not edit!")
configure_file(lit.site.cfg.in lit.site.cfg @ONLY)

